<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<link href="css/main.css" rel="stylesheet" type="text/css">
<title>言語を作ろうプロジェクト（2019年）</title>
</head>
<body>
<!-- 全体コンテナ　-->
<div id="container">
<div id="header">
<h3>０３．トレース言語とインタプリタ</h3>
</div>
<!-- コンテンツ　-->
<div id="contents">
<h3>０３－０２．構文解析と処理</h3>
　<b>oreProject</b>には<b>字句解析</b>として<b>Flex（UNIXではlex）</b>と<b>構文解析</b>として<b>Bison（UNIXではyacc）</b>を使用する形になっています。<br />
　それぞれの定義ファイル<b>FlexはoreProject.l</b>で<b>BisonはoreProject.y</b>を記述し、ビルドすると<b>FlexがoreProject.flex.cpp</b>で<b>BisonがoreProject.tab.hとoreProject.tab.cpp</b>を書きだします。<br />
　メインプロジェクトではそれらのファイルを<b>main.cppと一緒に</b>ビルドし、実行ファイルを作成します。<br />
　現在、例えば<b>10 + 12</b>という計算式が出てきたときには、どういう処理がされているのでしょうか。<br />
　それは<b>oreProject.y</b>に直接記述されています。<br />
　26行目付近の
<div class="box1">
<pre>
expression
    : term
    | expression ADD term
    {
        $$ = $1 + $3;
    }
</pre>
</div>
　という部分です。ここで<b>$1に10、$3に12</b>が入ってくるので、結果<b>$$に演算結果を代入</b>します。<br />
　今回のような簡単な計算機ならよいのですが、複雑になってくると<b>Bison</b>での処理で行うのは無理があります。<br />
　そこで、<b>処理（processing）</b>という考え方が出てきます。<br />
　例えば、<b>足し算</b>も<b>処理</b>だし、<b>関数呼び出し</b>も<b>処理</b>です。<br />
　ですので、<b>Bison</b>の定義ファイルでは<b>処理</b>が必要になったところで、CPP側の関数を呼び出すように修正します。<br />
　こうしておけば<b>CPP側</b>で複雑な処理も記述できるようになります。<br />
<h4>CPP側ファイルの作成</h4>
　まず<b>ソリューションエクスプローラ</b>で<b>oreProjectプロジェクト</b>の<b>ヘッダーファイル</b>を右クリックし、<b>追加－新しい項目</b>で<b>proc.h</b>（ヘッダファイル）を作成します。（この項からは、最低限必要な時以外は画像は用意しませんので、各自操作してください。前項までの操作とほぼ変わりません。）<br/>
　そこに以下のように記述します。
<div class="box1">
<pre>
#pragma once

namespace ore {

    /// 加算処理
    double procAdd(double a, double b);

    /// 減算処理
    double procSub(double a, double b);

    /// 乗算処理
    double procMul(double a, double b);

    /// 除算処理
    double procDiv(double a, double b);

}
//end namespace ore
</pre>
</div>
　ここで出てくる
<div class="box1">
<pre>
namespace ore
</pre>
</div>
　というのは、いわゆる<b>グループ化</b>の意味合いがあります。こうすることで、関数名のバッティングを防ぐことができます。<br />
　記述したら、今度は<b>oreProjectプロジェクト</b>の<b>ソースファイル</b>に<b>proc.cpp</b>を作成します。<br />
　作成後、以下を記述します。
<div class="box1">
<pre>
#include "proc.h"

namespace ore {

    /// 加算処理
    double procAdd(double a, double b) {
        return a + b;
    }

    /// 減算処理
    double procSub(double a, double b) {
        return a - b;
    }

    /// 乗算処理
    double procMul(double a, double b) {
        return a * b;
    }

    /// 除算処理
    double procDiv(double a, double b) {
        //0除算は見ない
        return a / b;
    }

}
//end namespace ore
</pre>
</div>
<h4>Bisonァイルの修正</h4>
　次に<b>FlexBisonプロジェクト</b>の<b>oreProject.y</b>に修正を加えます。<br />
　まず冒頭の<b>インクルード</b>があるあたりで
<div class="box1">
<pre>
%{
#include &lt;stdio.h>
#include &lt;stdlib.h>
#define YYDEBUG 1

//続く...
</pre>
</div>
　となっているところを
<div class="box1">
<pre>
%{
#include &lt;stdio.h>
#include &lt;stdlib.h>
<span class="red">#include "../oreProject/proc.h"</span>
#define YYDEBUG 1

//続く...
</pre>
</div>
　とします。<br />
　また<b>27行目付近</b>から
<div class="box1">
<pre>
expression
    : term
    | expression ADD term
    {
        $$ = $1 + $3;
    }
    | expression SUB term
    {
        $$ = $1 - $3;
    }
    ;
term
    : primary_expression
    | term MUL primary_expression 
    {
        $$ = $1 * $3;
    }
    | term DIV primary_expression
    {
        $$ = $1 / $3;
    }
    ;
</pre>
</div>
となっているところを
<div class="box1">
<pre>
expression
    : term
    | expression ADD term
    {
        <span class="red">$$ = ore::procAdd($1,$3);</span>
    }
    | expression SUB term
    {
        <span class="red">$$ = ore::procSub($1,$3);</span>
    }
    ;
term
    : primary_expression
    | term MUL primary_expression 
    {
        <span class="red">$$ = ore::procMul($1,$3);</span>
    }
    | term DIV primary_expression
    {
        <span class="red">$$ = ore::procDiv($1,$3);</span>
    }
    ;
</pre>
</div>
　とします。<br />
　<b>ビルド－ソリューションのリビルド</b>でビルドし、<b>デバッグ－デバッグなしで開始</b>で、前項のような出力があれば成功です。
　次項では<b>ステートメント</b>を作成しましょう。
</div>
<!-- /コンテンツ　-->
<hr>
<!-- フッタ　-->
<ul class="foot_navi">
<li><a href="03_01.html">前ページ</a></li>
<li><a href="index.html">目次</a></li>
<li><a href="03_03.html">次ページ</a></li>
</ul>
<!-- /フッタ　-->


</div>
<!-- /全体コンテナ　-->
</body>
</html>
