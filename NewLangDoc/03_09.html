<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<link href="css/main.css" rel="stylesheet" type="text/css">
<title>言語を作ろうプロジェクト（2019年）</title>
</head>
<body>
<!-- 全体コンテナ　-->
<div id="container">
<div id="header">
<h3>０３．トレース言語とインタプリタ</h3>
</div>
<!-- コンテンツ　-->
<div id="contents">
<h3>０３－０９．インタプリタの構造</h3>
　さて、前項では<b>インタプリタとは何か</b>を考え、簡単な実装を行いました。<br >
　しかし、<b>表示文</b>を構造体の配列として保持しただけで、このまま作成を進めたのでは、いつしか収集がつかなくなります。<br />
<h4>構造を考える</h4>
　ここから先は、開発する人により、全く考え方が違うと思います。ようは
<div class="box1">
<pre>
１、コンパイル
２、実行
３、破棄
</pre>
</div>
　という流れを実装すればよいので、このドキュメントが決定的なものではないという前提の上、この後をお読みください。<br />
　あくまで<b>僕ならこう書く</b>の例です。<br />
<br />
　このドキュメントでは<b>命令</b>をデータ化する方法として以下の様なオブジェクトを作成します
<div class="box1">
<pre>
１、値クラス
２、式クラス
３、文クラス
</pre>
</div>
　C/C++の文法では<b>値</b>も<b>式</b>として評価されます。しかし、式の演算結果をどこかに取っておくには、<b>クラス化</b>してとっておくほうが考えやすいのではないかという設計です。<br />
　たとえば、以下の様な構文
<div class="box1">
<pre>
//数字で初期化
test1 = 123;
//文字列を連結
test1 &= "abc";
</pre>
</div>
　数値で初期化した<b>test1</b>変数に、文字列を連結させています。PHPのような使い方をできるようにするためには、変数の<b>型</b>が常に変化することを許容しなければいけません。<br />
　それを実装するのに<b>値クラス</b>には様々な<b>型変換的な</b>ものも含め、柔軟な設計にしなければいけません。<br />
　では早速作成してみましょう。<br/>
<h4>クラス作成の準備</h4>
　値クラス作成の前に、まず、<b>oreProject</b>に<b>util.h</b>というヘッダファイルを作成して、以下を記述します。
<div class="box1">
<pre>
#pragma once

#include &lt;cstdlib>
#include &lt;iostream>
#include &lt;string>
#include &lt;set>
#include &lt;map>
#include &lt;vector>
#include &lt;list>
#include &lt;memory>
using namespace std;

namespace ore {

#define ORE_MAX_TOKEN_LEN 255

    ///stringを255文字に切り詰める
    inline string clampToken(const char* ext) {
        string str(ext);
        if (str.size() > ORE_MAX_TOKEN_LEN) {
            str.erase(ORE_MAX_TOKEN_LEN);
        }
        return str;
    }

}
//end namespace ore
</pre>
</div>
　この<b>util.h</b>の役割は、<b>STLの使用</b>にあります。Windows用のBisonのライブラリはなぜか<b>STL</b>が使えません。<br />
　このため少し工夫が必要です。<br />
　<b>oreProject.y</b>は<b>oreProject側</b>のヘッダファイルをインクルードする必要があります。今は
<div class="box1">
<pre>
#include "../oreProject/proc.h"
</pre>
</div>
　のような記述があります。<br />
　そのため<b>proc.h</b>やその中にインクルードされているヘッダファイル内には<b>STL</b>の構文は記述できないのです。<br />
　しかしC++で記述するにあたって<b>STL</b>が使用できないのでは全く意味がありません。<br />
　そのため以下の2つのテクニックを使って<b>STL</b>を使用できるようにします。
<div class="box1">
<pre>
１、util.hを作成してその中にSTL用のヘッダは記述する。その際util.hはBison側からは見えないようにする
２、Implイディオムを使って、ヘッダではSTLを使わずに、cppファイルではSTLを使えるようにする。
</pre>
</div>
　１、については、この後記述する<b>value.cpp</b>などで<b>util.h</b>をインクルードして、STLをヘッダでも使えるようにします。<br />
　<b>util.h</b>がBison側から見えないので、問題はおきません。<br />
　２、については<b>Implイディオム</b>について少し説明しなければなりません。<br />
　C/C++では、コンパイル済みの<b>.libファイル（Linuxでは.a）</b>を使って静的にリンクすることができます。しかしその際、そのlibファイルと一緒に、ヘッダファイルを配布しなければなりません。<br />
　ヘッダファイルにはC++の場合、クラスの宣言部などが入ります。しかし、そこにいくら<b>private宣言</b>していても、libファイル使用者にも<b>丸見え</b>になってしまいます。<br />
　これを回避するために<b>Implイディオム</b>というテクニックを使うと、クラスのメンバ変数などを隠すことが可能となります。<br />
　このテクニックを使って（今回の使用目的は隠すことではなく、Bison側から見えなくするためですが）、<b>STLの使用</b>をcpp側に閉じ込めることができます。<br />
　それを実装しているのが、次項で紹介する<b>value.h/cpp</b>です。<br />
</div>
<!-- /コンテンツ　-->
<hr>
<!-- フッタ　-->
<ul class="foot_navi">
<li><a href="03_08.html">前ページ</a></li>
<li><a href="index.html">目次</a></li>
<li><a href="03_10.html">次ページ</a></li>
</ul>
<!-- /フッタ　-->
</div>
<!-- /全体コンテナ　-->
</body>
</html>
