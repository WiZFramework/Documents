<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<link href="css/main.css" rel="stylesheet" type="text/css">
<title>言語を作ろうプロジェクト（2019年）</title>
</head>
<body>
<!-- 全体コンテナ　-->
<div id="container">
<div id="header">
<h3>０４．本格的な実装</h3>
</div>
<!-- コンテンツ　-->
<div id="contents">
<h3>０４－０２．文字列リテラル式の実装</h3>
<h4>文字列リテラルとは</h4>
　たとえば<br />
　<b>"hello world!"</b><br/>
　というのは文字列です。<b>"</b>と<b>"</b>に囲んで表現します。<br />
　前項では<b>整数リテラル</b>を実装しました。つまり<b>数字が並んだもの</b>を<b>10進数の整数とする</b>という表現方法だったわけですが、このような考え方は文字列にも当てはまります。<br />
　つまり、
<div class="box1">
<pre>
" と " に囲まれた文字の並びは、文字列とする
</pre>
</div>
　という文法です。これを<b>文字列リテラル（文字列表現）</b>といいます。<br />
　oreProjectは<b>文字</b>という考え方はありません。つまり<b>1文字でも文字列</b>として扱います。<br />
　また、oreProjectは<b>改行</b>も文字列に含めることができます。
<div class="box1">
<pre>
"こんにちは
世界"
</pre>
</div>
　も文字列です。<br />
　それに加え<b>'</b>と<b>'</b>に囲む方法も<b>文字列リテラル</b>とします。
<div class="box1">
<pre>
' と ' に囲まれた文字の並びは、文字列とする
</pre>
</div>
　とします。<b>"</b>と<b>'</b>の違いは、例えばPHPのように<b>"ならば変数展開する</b>のようにしたいとも思いますが、今のところ考えないでおきます。
<h4>expression.h/cpp</h4>
　<b>文字列リテラル</b>は<b>式</b>として作成します。ですので、最初の記述は<b>expression.h</b>から行います。<br />
　冒頭のタイプ宣言部分で
<div class="box1">
<pre>
    enum class ExpressionType {
        noExp = 0,
        intLiteralExp,
        doubleLiteralExp,
        <span class="red">stringLiteralExp,</span>
        variableExp,
//中略
        expTypeCount
    };
</pre>
</div>
　のように記述します。そして<b>DoubleLiteralExpクラス</b>の下あたりに
<div class="box1">
<pre>
    //--------------------------------------------------------------------------------------
    ///  stringリテラル式クラス
    //--------------------------------------------------------------------------------------
    class StringLiteralExp : public Expression {
    public:
        StringLiteralExp(const char* str);
        virtual ~StringLiteralExp();
        const char* getStringLiteral() const;
        virtual Value Excute() const  override;
    private:
        // pImplイディオム
        struct Impl;
        Impl* pImpl;
    };
</pre>
</div>
　と記述します。<br />
　<b>expression.cpp</b>は95行目あたりに
<div class="box1">
<pre>
    //--------------------------------------------------------------------------------------
    ///  stringリテラル式クラス
    //--------------------------------------------------------------------------------------
    struct StringLiteralExp::Impl {
        string m_StringLiteral;
    };

    StringLiteralExp::StringLiteralExp(const char* str) :
        Expression(ExpressionType::stringLiteralExp),
        pImpl(new Impl)
    {
        pImpl->m_StringLiteral = str;
    }
    StringLiteralExp::~StringLiteralExp() {
        delete pImpl;
    }

    const char* StringLiteralExp::getStringLiteral()const {
        return pImpl->m_StringLiteral.c_str();
    }

    Value StringLiteralExp::Excute() const {
        setRuntimeLineNumber();
        return Value(pImpl->m_StringLiteral.c_str());
    }
</pre>
</div>
　と記述します。
<h4>interpreter.h/cpp</h4>
　続いて<b>Interpreterクラス</b>ですが、<b>interpreter.h</b>の42行目あたりに以下を記述します。
<div class="box1">
<pre>
        //文字列リテラル
        void startStringLiteral();
        void addStringLiteral(char ext);
        Expression* createStringLiteralExp();
</pre>
</div>
　続いて<b>interpreter.cpp</b>です。<br />
　<b>Interpreter::Impl構造体</b>に以下を記述します。赤くなっているところです。
<div class="box1">
<pre>
    struct Interpreter::Impl {
        set&lt;string> m_FixedStringPool;
        vector&lt;ObjBase*> m_ObjectPool;
        map&lt;string, string> m_ConfigMap;
        <span class="red">//文字列リテラル作成用
        string m_LiteralTemp;</span>
//中略
    };
</pre>
</div>
　この変数は、<b>文字列リテラル</b>を中間的にためておく文字列クラスです。<br />
　<b>文字列リテラル</b>は<b>文字</b>を一文字一文字貯めておいて、完成した段階で作成します。<br />
　続いて<b>interpreter.cpp</b>の241行目あたりに以下を記述します。
<div class="box1">
<pre>
    void Interpreter::startStringLiteral() {
        pImpl->m_LiteralTemp = "";
    }

    void Interpreter::addStringLiteral(char ext) {
        pImpl->m_LiteralTemp += ext;
    }

    Expression* Interpreter::createStringLiteralExp() {
        auto ptr = new StringLiteralExp(pImpl->m_LiteralTemp.c_str());
        pImpl->m_LiteralTemp = "";
        pImpl->m_ObjectPool.push_back(ptr);
        return ptr;
    }
</pre>
</div>
　これでC++側で受け入れ準備ができました。
<h4>oreProject.l</h4>
　<b>Flexファイル</b>は複数行コメントのように記述します。<br />
　まず、11行目あたりに
<div class="box1">
<pre>
%s LINE_COMMENT
<span class="red">%s STR_LITERAL_ST_D
%s STR_LITERAL_ST_S</span>
%%
</pre>
</div>
　とし、29行目付近で
<div class="box1">
<pre>
    "/*"   { BEGIN(COMMENT);}
    [/][/]+ { BEGIN(LINE_COMMENT);}
    <span class="red">"\""    {
                ore::Interpreter::getInp()->startStringLiteral();
                BEGIN(STR_LITERAL_ST_D);
            }
    "\'"    {
                ore::Interpreter::getInp()->startStringLiteral();
                BEGIN(STR_LITERAL_ST_S);
            }</span>
    [0-9][0-9]* {
        yylval.expression = ore::Interpreter::getInp()->createIntLiteralExp(yytext);
        return INT_LITERAL;
    }
</pre>
</div>
　とします。そして62行目付近で
<div class="box1">
<pre>
<span class="red">&lt;STR_LITERAL_ST_D>{
    "\n"    { gLine++; ore::Interpreter::getInp()->addStringLiteral('\n'); }
    "\""    { BEGIN(INITIAL); return STR_LITERAL; }
    .       { ore::Interpreter::getInp()->addStringLiteral(yytext[0]); }
}
&lt;STR_LITERAL_ST_S>{
    "\n"    { gLine++; ore::Interpreter::getInp()->addStringLiteral('\n'); }
    "\'"    { BEGIN(INITIAL); return STR_LITERAL; }
    .       { ore::Interpreter::getInp()->addStringLiteral(yytext[0]); }
}</span>
%%
</pre>
</div>
　とします。
<h4>oreProject.y</h4>
　<b>Bisonファイル</b>は25行目を以下のように修正し
<div class="box1">
<pre>
%token &lt;expression>  INT_LITERAL DOUBLE_LITERAL  <span class="red">STR_LITERAL</span>
</pre>
</div>
　<b>primary_expression</b>の項目に
<div class="box1">
<pre>
primary_expression
    : identifier_expression
    | constart_expression
    <span clas="red">| STR_LITERAL
    {
        $$ = ore::Interpreter::getInp()->createStringLiteralExp();
    }</span>
    ;
</pre>
</div>
　と追加します。
<h4>index.ore</h4>
　ここで<b>リビルド</b>します。上記が実装されていれば通るはずです。<br />
　最後に<b>index.ore</b>を以下のように書き換えます
<div class="box1">
<pre>
a = "abc";
pn a;
pn "hello
world!!";
</pre>
</div>
　<b>デバッグ-デバッグなしで開始</b>で以下が出力されれば成功です。
<div class="box1">
<pre>
abc
hello
world!!

...\oreProject.exe (プロセス 4220) は、コード 0 を伴って終了しました。
このウィンドウを閉じるには、任意のキーを押してください . . .
</pre>
</div>
</div>
<!-- /コンテンツ　-->
<hr>
<!-- フッタ　-->
<ul class="foot_navi">
<li><a href="04_01.html">前ページ</a></li>
<li><a href="index.html">目次</a></li>
<li><a href="04_03.html">次ページ</a></li>
</ul>
<!-- /フッタ　-->
</div>
<!-- /全体コンテナ　-->
</body>
</html>
